<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    
    <!-- PWA Мета-теги -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="МИРУМ Калькулятор">
    
    <!-- Manifest -->
    <link rel="manifest" href="/site.webmanifest">
    
    <!-- Иконки -->
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/img/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
    <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
    
    <!-- Цвета темы -->
    <meta name="theme-color" content="#1a3a5f">
    <meta name="msapplication-TileColor" content="#1a3a5f">
    
    <!-- Заголовок и описание -->
    <title>Калькулятор аренды ковров МИРУМ</title>
    <meta name="description" content="PWA приложение калькулятора стоимости аренды грязезащитных ковров. Работает офлайн.">
    
    <!-- Стили -->
    <style>
        /* Основные переменные */
        :root {
            --primary-color: #1a3a5f;
            --secondary-color: #2c5aa0;
            --accent-color: #16a085;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --background-color: #f8f9fa;
            --border-color: #e0e0e0;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        /* Сброс стилей */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            height: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background-color: var(--background-color);
            font-size: 16px;
            min-height: 100vh;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Хедер */
        .main-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            color: var(--accent-color);
        }
        
        .offline-badge {
            background: var(--accent-color);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Герой-секция */
        .hero {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 60px 0 40px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .hero h1 {
            color: white;
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            margin-bottom: 20px;
        }
        
        .hero p {
            font-size: clamp(1rem, 2vw, 1.1rem);
            max-width: 800px;
            margin: 0 auto 30px;
            line-height: 1.6;
            color: #ffffff;
        }
        
        /* Калькулятор */
        .calculator-section {
            padding: 20px 0;
        }
        
        .calculator-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }
        
        .tab-btn {
            padding: 12px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: -2px;
        }
        
        .tab-btn.active {
            color: var(--accent-color);
            border-bottom: 3px solid var(--accent-color);
        }
        
        /* Формы */
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        select, input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            background: white;
            font-family: inherit;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(22, 160, 133, 0.1);
        }
        
        select:disabled, input:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* Месяцы для тендера */
        .month-inputs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .month-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .month-box label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .month-box input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }
        
        /* Список позиций */
        .positions-list {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-top: 30px;
            border: 2px solid #f0f0f0;
        }
        
        .position-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .remove-position-btn {
            background: #e74c3c;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            margin-left: 10px;
        }
        
        .remove-position-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }
        
        /* Результаты */
        .calculator-results {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-top: 30px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        /* Кнопки */
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 16px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            text-decoration: none;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--accent-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #138a72;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #3498db;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-telegram {
            background: #0088cc;
            color: white;
        }
        
        .btn-telegram:hover {
            background: #0077b5;
            transform: translateY(-2px);
        }
        
        /* Переключатель НДС */
        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .switch-label {
            flex: 1;
        }
        
        .switch-label h4 {
            margin: 0 0 5px 0;
            color: white;
            font-size: 1rem;
        }
        
        .switch-label p {
            margin: 0;
            font-size: 0.85rem;
            opacity: 0.9;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
            flex-shrink: 0;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--success-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        /* НДС детализация */
        .vat-details {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .vat-details.show {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .vat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .vat-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        /* Футер */
        footer {
            background: var(--primary-color);
            color: white;
            padding: 40px 0;
            margin-top: 60px;
        }
        
        .footer-content {
            text-align: center;
        }
        
        .footer-disclaimer {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius);
        }
        
        /* Уведомления */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
            max-width: 300px;
            font-size: 14px;
            font-weight: 500;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            .calculator-container {
                padding: 20px;
            }
            
            .month-inputs {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                flex: 1;
                min-width: 120px;
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .switch {
                width: 50px;
                height: 26px;
            }
            
            .slider:before {
                height: 18px;
                width: 18px;
                left: 4px;
                bottom: 4px;
            }
            
            input:checked + .slider:before {
                transform: translateX(24px);
            }
        }
        
        @media (max-width: 480px) {
            .month-inputs {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .tab-btn {
                min-width: 100px;
                padding: 8px 10px;
                font-size: 0.85rem;
            }
            
            .switch-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .switch {
                align-self: flex-end;
            }
        }
        
        /* iOS специфичные стили */
        @supports (-webkit-touch-callout: none) {
            select, input, textarea {
                font-size: 16px !important;
            }
        }
    </style>
    
    <!-- Иконки Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Service Worker регистрация -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js').then(
                    function(registration) {
                        console.log('✅ ServiceWorker зарегистрирован: ', registration.scope);
                    },
                    function(err) {
                        console.log('❌ Ошибка ServiceWorker: ', err);
                    }
                );
            });
        }
    </script>
</head>
<body>
    <!-- Шапка -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-calculator"></i>
                    <span>МИРУМ Калькулятор</span>
                    <span class="offline-badge">PWA</span>
                </div>
                <div style="font-size: 14px; opacity: 0.9;">
                    <span id="connectionStatus">Онлайн</span> • v2.2
                </div>
            </div>
        </div>
    </header>

    <!-- Основной контент -->
    <main>
        <!-- Герой-секция -->
        <section class="hero">
            <div class="container">
                <h1>
                    <i class="fas fa-mobile-alt"></i> PWA Приложение калькулятора
                </h1>
                
                <p>
                    Установите на главный экран! Работает автономно, быстро загружается, 
                    выглядит как родное приложение.
                </p>
                
                <div style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 10px; max-width: 600px; margin: 0 auto;">
                    <p style="margin: 0; font-size: 0.95rem; color: #ffffff;">
                        <i class="fas fa-info-circle" style="color: #1abc9c;"></i> 
                        <strong>Как установить:</strong><br>
                        • <strong>Android:</strong> Chrome → меню → "Установить приложение"<br>
                        • <strong>iPhone:</strong> Safari → Поделиться → "На экран "Домой""
                    </p>
                </div>
                
                <!-- Кнопка установки (появится автоматически) -->
                <div id="installContainer" style="margin-top: 20px; display: none;">
                    <button id="installButton" class="btn" style="background: #27ae60; color: white;">
                        <i class="fas fa-download"></i> Установить приложение
                    </button>
                </div>
            </div>
        </section>

        <!-- Калькулятор -->
        <section class="calculator-section">
            <div class="container">
                <!-- Табы -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="showTab('standard')">Стандартный</button>
                    <button class="tab-btn" onclick="showTab('tender')">Тендерный</button>
                </div>
                
                <!-- Стандартный калькулятор -->
                <div id="standard-calc" class="calculator-container">
                    <div class="calculator-form">
                        <h2 style="text-align: center; margin-bottom: 30px;">
                            <i class="fas fa-calculator"></i> Рассчитать стоимость
                        </h2>
                        
                        <p style="text-align: center; color: #666; margin-bottom: 25px;">
                            Заполните поля ниже - позиции будут добавляться автоматически
                        </p>
                        
                        <!-- Регион -->
                        <div class="form-group">
                            <label for="region">
                                <i class="fas fa-map-marker-alt"></i> Регион
                            </label>
                            <select id="region" aria-label="Выберите регион">
                                <option value="">Выберите регион</option>
                            </select>
                            <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                Выберите город или область, где нужны ковры
                            </p>
                        </div>
                        
                        <!-- Размер -->
                        <div class="form-group">
                            <label for="size">
                                <i class="fas fa-ruler-combined"></i> Размер ковра
                            </label>
                            <select id="size" disabled aria-label="Выберите размер ковра">
                                <option value="">Сначала выберите регион</option>
                            </select>
                            <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                Доступные размеры зависят от выбранного региона
                            </p>
                        </div>
                        
                        <!-- Периодичность -->
                        <div class="form-group">
                            <label for="frequency">
                                <i class="fas fa-sync-alt"></i> Периодичность замены
                            </label>
                            <select id="frequency" disabled aria-label="Выберите периодичность замены">
                                <option value="">Сначала выберите размер</option>
                            </select>
                            <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                Как часто нужно менять ковры
                            </p>
                        </div>
                        
                        <!-- Количество -->
                        <div class="form-group">
                            <label for="quantity">
                                <i class="fas fa-layer-group"></i> Количество ковров
                            </label>
                            <input type="number" id="quantity" value="1" min="1" max="100" 
                                   aria-label="Введите количество ковров">
                            <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                Укажите необходимое количество одинаковых ковров
                            </p>
                        </div>
                    </div>
                    
                    <!-- Список позиций -->
                    <div class="positions-list" id="positionsList">
                        <h3 style="margin-bottom: 20px;">
                            <i class="fas fa-list"></i> Добавленные позиции
                        </h3>
                        <div id="positionsContainer">
                            <div style="text-align: center; color: #666; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                                <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px; display: block; color: #3498db;"></i>
                                <p>Позиции не добавлены</p>
                                <p style="font-size: 0.9rem; margin-top: 10px;">Заполните форму выше, и позиция добавится автоматически</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Итоговый результат -->
                    <div id="totalResult" style="display: none;"></div>
                </div>
                
                <!-- Тендерный калькулятор -->
                <div id="tender-calc" class="calculator-container" style="display: none;">
                    <div class="calculator-form">
                        <h2 style="text-align: center; margin-bottom: 30px;">
                            <i class="fas fa-file-contract"></i> Тендерный расчет
                        </h2>
                        
                        <!-- Регион для тендера -->
                        <div class="form-group">
                            <label for="tender-region">
                                <i class="fas fa-map-marker-alt"></i> Регион
                            </label>
                            <select id="tender-region" aria-label="Выберите регион для тендера">
                                <option value="">Выберите регион</option>
                            </select>
                        </div>
                        
                        <!-- Размер для тендера -->
                        <div class="form-group">
                            <label for="tender-size">
                                <i class="fas fa-ruler-combined"></i> Размер ковра
                            </label>
                            <select id="tender-size" disabled aria-label="Выберите размер ковра для тендера">
                                <option value="">Сначала выберите регион</option>
                            </select>
                        </div>
                        
                        <!-- Месяцы -->
                        <div class="month-inputs" id="monthInputs"></div>
                        
                        <!-- Кнопка расчета -->
                        <button class="btn btn-primary" id="calculateTenderBtn" style="margin-top: 20px; width: 100%; padding: 15px; font-size: 16px;">
                            <i class="fas fa-calculator"></i> Рассчитать тендер
                        </button>
                    </div>
                    
                    <!-- Результаты тендера -->
                    <div class="calculator-results" id="tender-result" style="display: none;">
                        <h3><i class="fas fa-file-invoice-dollar"></i> Расчет по тендеру</h3>
                        
                        <div id="tenderPositions"></div>
                        
                        <div id="tenderTotal" style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 18px; font-weight: bold;">
                            Общая стоимость: <span id="tenderTotalValue">0</span> ₽
                        </div>
                        
                        <!-- Переключатель НДС для тендера -->
                        <div class="switch-container" style="margin-top: 20px;">
                            <div class="switch-label">
                                <h4>Расчет с НДС 22%</h4>
                                <p>Мы можем работать с НДС 22%. Хотите сделать расчет?</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="tenderVatToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <!-- Детализация НДС для тендера -->
                        <div class="vat-details" id="tenderVatDetails">
                            <div class="vat-row">
                                <span>Стоимость без НДС:</span>
                                <span id="tenderWithoutVat">0</span> ₽
                            </div>
                            <div class="vat-row">
                                <span>НДС 22%:</span>
                                <span id="tenderVatAmount">0</span> ₽
                            </div>
                            <div class="vat-row">
                                <span>Итого с НДС:</span>
                                <span id="tenderWithVat">0</span> ₽
                            </div>
                        </div>
                        
                        <div class="results-actions" style="margin-top: 20px;">
                            <button class="btn btn-telegram" id="sendTenderToTelegram" style="width: 100%; padding: 15px; font-size: 16px;">
                                <i class="fab fa-telegram"></i> Отправить тендер в Telegram
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Информационные блоки -->
                <div class="documents-info" style="background: white; padding: 25px; border-radius: var(--border-radius); margin-top: 30px; box-shadow: var(--box-shadow);">
                    <h4><i class="fas fa-file-contract"></i> Для заключения договора потребуются:</h4>
                    <ul style="list-style: none; margin: 15px 0; padding: 0;">
                        <li style="padding: 8px 0; padding-left: 25px; position: relative;">Реквизиты компании</li>
                        <li style="padding: 8px 0; padding-left: 25px; position: relative;">Подписант (ФИО, основание полномочий)</li>
                        <li style="padding: 8px 0; padding-left: 25px; position: relative;">Точный адрес объекта и название, вывеска</li>
                        <li style="padding: 8px 0; padding-left: 25px; position: relative;">Режим работы объекта</li>
                        <li style="padding: 8px 0; padding-left: 25px; position: relative;">Контактное лицо (ФИО, телефон) для связи с курьером</li>
                    </ul>
                    
                    <div style="margin-top: 15px; padding: 15px; background: #e8f4fd; border-radius: 8px;">
                        <p style="margin: 0; color: #2c3e50; font-size: 0.9rem;">
                            <i class="fas fa-info-circle" style="color: #3498db;"></i> 
                            <strong>Условия:</strong> Счёт выставляется только за фактические замены. Возможно включить НДС 22% — цена увеличится на ставку налога. Можем работать как с НДС, так и без НДС.
                        </p>
                    </div>
                </div>
                
                <div class="calculator-info" style="background: white; padding: 25px; border-radius: var(--border-radius); margin-top: 30px; box-shadow: var(--box-shadow);">
                    <h3><i class="fas fa-check-circle"></i> Что включено в стоимость аренды:</h3>
                    <ul style="list-style: none; margin: 15px 0; padding: 0;">
                        <li style="padding: 8px 0; padding-left: 25px; position: relative;"><strong>Бесплатная доставка</strong> - привозим чистые ковры прямо к вам</li>
                        <li style="padding: 8px 0; padding-left: 25px; position: relative;"><strong>Установка и замена</strong> - наши курьеры установят и заберут грязные ковры</li>
                        <li style="padding: 8px 0; padding-left: 25px; position: relative;"><strong>Профессиональная чистка</strong> - все ковры проходят санитарную обработку</li>
                        <li style="padding: 8px 0; padding-left: 25px; position: relative;"><strong>Замена при износе</strong> - бесплатно меняем изношенные ковры на новые</li>
                        <li style="padding: 8px 0; padding-left: 25px; position: relative;"><strong>Все документы</strong> - договор, акты, счета для бухгалтерии</li>
                        <li style="padding: 8px 0; padding-left: 25px; position: relative;"><strong>Гибкий график</strong> - подстроимся под ваш режим работы</li>
                    </ul>
                </div>
            </div>
        </section>
    </main>

    <!-- Футер -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <h3 style="color: white;">PWA Приложение калькулятора</h3>
                
                <div style="margin: 20px 0; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
                    <div style="text-align: center;">
                        <i class="fab fa-telegram" style="font-size: 24px; color: #0088cc; margin-bottom: 5px; display: block;"></i>
                        <div style="font-size: 0.9rem;">Telegram</div>
                        <div style="font-weight: 600;">@+79770005127</div>
                    </div>
                    <div style="text-align: center;">
                        <i class="fas fa-phone" style="font-size: 24px; color: #1abc9c; margin-bottom: 5px; display: block;"></i>
                        <div style="font-size: 0.9rem;">Телефон</div>
                        <div style="font-weight: 600;">+7 (977) 000-51-27</div>
                    </div>
                    <div style="text-align: center;">
                        <i class="fas fa-envelope" style="font-size: 24px; color: #e74c3c; margin-bottom: 5px; display: block;"></i>
                        <div style="font-size: 0.9rem;">Email</div>
                        <div style="font-weight: 600;">matservice@yandex.ru</div>
                    </div>
                </div>
                
                <div class="footer-disclaimer">
                    <p><strong>Progressive Web App (PWA)</strong></p>
                    <p>Установите это приложение на главный экран для быстрого доступа. Работает офлайн.</p>
                    <p style="margin-top: 10px; font-size: 12px;">Версия 2.2 • PWA • Все права защищены © МИРУМ</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Основной скрипт калькулятора -->
    <script>
        // ============================================
        // БАЗА ЦЕН (без НДС)
        // ============================================
        const priceData = {
            "Москва": {
                "85*60": { "1 раз в две недели": 180, "1 раз в неделю": 180, "2 раза в неделю": 180, "3 раза в неделю": 180, "4 раза в неделю": 180, "5 раз в неделю": 180, "6 раз в неделю": 180, "7 раз в неделю": 180 },
                "85*150": { "1 раз в две недели": 420, "1 раз в неделю": 420, "2 раза в неделю": 420, "3 раза в неделю": 420, "4 раза в неделю": 420, "5 раз в неделю": 420, "6 раз в неделю": 420, "7 раз в неделю": 420 },
                "115*200": { "1 раз в две недели": 760, "1 раз в неделю": 760, "2 раза в неделю": 760, "3 раза в неделю": 760, "4 раза в неделю": 760, "5 раз в неделю": 760, "6 раз в неделю": 760, "7 раз в неделю": 760 },
                "115*400": { "1 раз в две недели": 2210, "1 раз в неделю": 2210, "2 раза в неделю": 2210, "3 раза в неделю": 2210, "4 раза в неделю": 2210, "5 раз в неделю": 2210, "6 раз в неделю": 2210, "7 раз в неделю": 2210 },
                "150*240": { "1 раз в две недели": 1180, "1 раз в неделю": 1180, "2 раза в неделю": 1180, "3 раза в неделю": 1180, "4 раза в неделю": 1180, "5 раз в неделю": 1180, "6 раз в неделю": 1180, "7 раз в неделю": 1180 },
                "150*300": { "1 раз в две недели": 1520, "1 раз в неделю": 1520, "2 раза в неделю": 1520, "3 раза в неделю": 1520, "4 раза в неделю": 1520, "5 раз в неделю": 1520, "6 раз в неделю": 1520, "7 раз в неделю": 1520 }
            },
            // ... остальные регионы (как в предыдущей версии)
            "Московская область": {
                "85*60": { "1 раз в две недели": 280, "1 раз в неделю": 280, "2 раза в неделю": 280, "3 раза в неделю": 280, "4 раза в неделю": 280, "5 раз в неделю": 280, "6 раз в неделю": 280, "7 раз в неделю": 280 },
                "85*150": { "1 раз в две недели": 620, "1 раз в неделю": 620, "2 раза в неделю": 620, "3 раза в неделю": 620, "4 раза в неделю": 620, "5 раз в неделю": 620, "6 раз в неделю": 620, "7 раз в неделю": 620 },
                "115*200": { "1 раз в две недели": 1110, "1 раз в неделю": 1110, "2 раза в неделю": 1110, "3 раза в неделю": 1110, "4 раза в неделю": 1110, "5 раз в неделю": 1110, "6 раз в неделю": 1110, "7 раз в неделю": 1110 },
                "115*400": { "1 раз в две недели": 2210, "1 раз в неделю": 2210, "2 раза в неделю": 2210, "3 раза в неделю": 2210, "4 раза в неделю": 2210, "5 раз в неделю": 2210, "6 раз в неделю": 2210, "7 раз в неделю": 2210 },
                "150*240": { "1 раз в две недели": 1730, "1 раз в неделю": 1730, "2 раза в неделю": 1730, "3 раза в неделю": 1730, "4 раза в неделю": 1730, "5 раз в неделю": 1730, "6 раз в неделю": 1730, "7 раз в неделю": 1730 },
                "150*300": { "1 раз в две недели": 2160, "1 раз в неделю": 2160, "2 раза в неделю": 2160, "3 раза в неделю": 2160, "4 раза в неделю": 2160, "5 раз в неделю": 2160, "6 раз в неделю": 2160, "7 раз в неделю": 2160 }
            },
            "Санкт-Петербург": {
                "85*60": { "1 раз в две недели": 830, "1 раз в неделю": 490, "2 раза в неделю": 420, "3 раза в неделю": 340, "4 раза в неделю": 340, "5 раз в неделю": 340, "6 раз в неделю": 340, "7 раз в неделю": 340 },
                "85*150": { "1 раз в две недели": 1000, "1 раз в неделю": 660, "2 раза в неделю": 590, "3 раза в неделю": 510, "4 раза в неделю": 510, "5 раз в неделю": 510, "6 раз в неделю": 510, "7 раз в неделю": 510 },
                "115*200": { "1 раз в две недели": 1330, "1 раз в неделю": 890, "2 раза в неделю": 840, "3 раза в неделю": 680, "4 раза в неделю": 680, "5 раз в неделю": 680, "6 раз в неделю": 680, "7 раз в неделю": 680 },
                "115*240": { "1 раз в две недели": 1500, "1 раз в неделю": 1000, "2 раза в неделю": 840, "3 раза в неделю": 760, "4 раза в неделю": 760, "5 раз в неделю": 760, "6 раз в неделю": 760, "7 раз в неделю": 760 },
                "115*400": { "1 раз в две недели": 2510, "1 раз в неделю": 1670, "2 раза в неделю": 1520, "3 раза в неделю": 1350, "4 раза в неделю": 1350, "5 раз в неделю": 1350, "6 раз в неделю": 1350, "7 раз в неделю": 1350 },
                "150*250": { "1 раз в две недели": 2000, "1 раз в неделю": 1330, "2 раза в неделю": 1180, "3 раза в неделю": 1010, "4 раза в неделю": 1010, "5 раз в неделю": 1010, "6 раз в неделю": 1010, "7 раз в неделю": 1010 },
                "150*300": { "1 раз в две недели": 2510, "1 раз в неделю": 1670, "2 раза в неделю": 1520, "3 раза в неделю": 1350, "4 раза в неделю": 1350, "5 раз в неделю": 1350, "6 раз в неделю": 1350, "7 раз в неделю": 1350 }
            }
            // ... остальные регионы остаются как были
        };

        const regionsOrder = [
            "Москва",
            "Московская область",
            "Санкт-Петербург", 
            "Ленинградская область",
            "Астрахань",
            "Астраханская область",
            "Волгоград",
            "Волгоградская область",
            "Воронеж",
            "Воронежская область",
            "Екатеринбург",
            "Свердловская область",
            "Иркутск",
            "Иркутская область",
            "Йошкар-Ола",
            "Республика Марий Эл",
            "Казань",
            "Республика Татарстан",
            "Кемерово",
            "Кемеровская область",
            "Красноярск",
            "Красноярский край",
            "Нижний Новгород",
            "Нижегородская область",
            "Новосибирск",
            "Новосибирская область", 
            "Омск",
            "Омская область",
            "Пермь",
            "Пермский край",
            "Ростов-на-Дону",
            "Ростовская область",
            "Саратов",
            "Саратовская область",
            "Сургут",
            "ХМАО",
            "Томск",
            "Томская область",
            "Тюмень",
            "Тюменская область",
            "Улан-Удэ",
            "Республика Бурятия",
            "Уфа",
            "Республика Башкортостан", 
            "Чебоксары",
            "Республика Чувашия",
            "Челябинск",
            "Челябинская область"
        ];
        
        // ============================================
        // ОСНОВНЫЕ ПЕРЕМЕННЫЕ КАЛЬКУЛЯТОРА
        // ============================================
        let positions = [];
        let includeVAT = false;  // По умолчанию НДС выключен
        const VAT_RATE = 0.22;
        let shouldAutoAdd = true;
        let deferredPrompt = null;
        
        // ============================================
        // УТИЛИТНЫЕ ФУНКЦИИ
        // ============================================
        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(price);
        }
        
        function showToast(message, type = 'success') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'success' ? '#27ae60' : 
                                   type === 'error' ? '#e74c3c' : 
                                   type === 'warning' ? '#f39c12' : '#3498db';
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                     type === 'error' ? 'exclamation-circle' : 
                                     type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function getPriceForPosition(region, size, frequency) {
            // Проверяем наличие данных
            if (!priceData[region] || !priceData[region][size] || !priceData[region][size][frequency]) {
                console.warn(`Цена не найдена для: ${region}, ${size}, ${frequency}`);
                
                // Если нет данных для этого региона/размера, используем стандартную логику
                if (priceData["Москва"] && priceData["Москва"][size] && priceData["Москва"][size][frequency]) {
                    // Используем московские цены как базовые
                    return priceData["Москва"][size][frequency];
                }
                
                // Если даже московских нет, используем базовую цену
                const basePrice = 500; // Базовая цена
                const frequencyMultipliers = {
                    "1 раз в две недели": 0.5,
                    "1 раз в неделю": 1,
                    "2 раза в неделю": 2,
                    "3 раза в неделю": 3,
                    "4 раза в неделю": 4,
                    "5 раз в неделю": 5,
                    "6 раз в неделю": 6,
                    "7 раз в неделю": 7
                };
                
                return basePrice * (frequencyMultipliers[frequency] || 1);
            }
            
            return priceData[region][size][frequency];
        }
        
        function calculateCostPer4Weeks(pricePerReplacement, quantity, frequency) {
            // ВАЖНО: pricePerReplacement - это цена ОДНОЙ замены ОДНОГО ковра
            
            // Количество замен в 4 недели (28 дней)
            const replacementsPer4Weeks = {
                "1 раз в две недели": 2,    // 2 замены в 4 недели
                "1 раз в неделю": 4,        // 4 замены в 4 недели
                "2 раза в неделю": 8,       // 8 замен в 4 недели (2 × 4)
                "3 раза в неделю": 12,      // 12 замен в 4 недели (3 × 4)
                "4 раза в неделю": 16,      // 16 замен в 4 недели (4 × 4)
                "5 раз в неделю": 20,       // 20 замен в 4 недели (5 × 4)
                "6 раз в неделю": 24,       // 24 замены в 4 недели (6 × 4)
                "7 раз в неделю": 28        // 28 замен в 4 недели (7 × 4)
            };
    
            const replacementsCount = replacementsPer4Weeks[frequency] || 4;
    
            // Формула: (цена_за_одну_замену) × (количество_замен_в_4_недели) × (количество_ковров)
            return pricePerReplacement * replacementsCount * quantity;
        }
        
        // ============================================
        // ИНИЦИАЛИЗАЦИЯ ИНТЕРФЕЙСА
        // ============================================
        function initInterface() {
            const regionSelect = document.getElementById('region');
            const sizeSelect = document.getElementById('size');
            const frequencySelect = document.getElementById('frequency');
            
            if (regionSelect) {
                regionSelect.innerHTML = '<option value="">Выберите регион</option>';
            }
            
            if (sizeSelect) {
                sizeSelect.innerHTML = '<option value="">Сначала выберите регион</option>';
                sizeSelect.disabled = true;
            }
            
            if (frequencySelect) {
                frequencySelect.innerHTML = '<option value="">Сначала выберите размер</option>';
                frequencySelect.disabled = true;
            }
            
            const quantityInput = document.getElementById('quantity');
            if (quantityInput && !quantityInput.value) {
                quantityInput.value = 1;
            }
            
            positions = [];
            includeVAT = false; // НДС выключен по умолчанию
            shouldAutoAdd = true;
            updatePositionsList();
        }
        
        function populateRegions() {
            const regionSelect = document.getElementById('region');
            const tenderRegionSelect = document.getElementById('tender-region');
            
            let regions = [];
            
            // Сначала добавляем регионы из порядка
            regionsOrder.forEach(region => {
                if (priceData[region]) {
                    regions.push(region);
                }
            });
            
            // Затем добавляем остальные регионы
            Object.keys(priceData).forEach(region => {
                if (!regions.includes(region)) {
                    regions.push(region);
                }
            });
            
            regions.sort();
            
            if (regionSelect) {
                regionSelect.innerHTML = '<option value="">Выберите регион</option>';
                regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region;
                    option.textContent = region;
                    regionSelect.appendChild(option);
                });
            }
            
            if (tenderRegionSelect) {
                tenderRegionSelect.innerHTML = '<option value="">Выберите регион</option>';
                regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region;
                    option.textContent = region;
                    tenderRegionSelect.appendChild(option);
                });
            }
        }
        
        function handleRegionChange(region) {
            const sizeSelect = document.getElementById('size');
            const frequencySelect = document.getElementById('frequency');
            
            if (!sizeSelect || !frequencySelect) return;
            
            if (!region) {
                sizeSelect.innerHTML = '<option value="">Сначала выберите регион</option>';
                sizeSelect.disabled = true;
                frequencySelect.innerHTML = '<option value="">Сначала выберите размер</option>';
                frequencySelect.disabled = true;
                return;
            }
            
            let sizes = [];
            
            if (priceData[region]) {
                sizes = Object.keys(priceData[region]).sort();
            }
            
            if (sizes.length === 0) {
                sizes = ["85*60", "85*150", "115*200", "115*400", "150*240", "150*300"];
            }
            
            sizeSelect.innerHTML = '<option value="">Выберите размер ковра</option>';
            
            sizes.forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                sizeSelect.appendChild(option);
            });
            
            sizeSelect.disabled = false;
            frequencySelect.innerHTML = '<option value="">Сначала выберите размер</option>';
            frequencySelect.disabled = true;
        }
        
        function handleSizeChange(region, size) {
            const frequencySelect = document.getElementById('frequency');
            
            if (!frequencySelect) return;
            
            if (!region || !size) {
                frequencySelect.innerHTML = '<option value="">Сначала выберите размер</option>';
                frequencySelect.disabled = true;
                return;
            }
            
            let frequencies = [];
            
            if (priceData[region] && priceData[region][size]) {
                frequencies = Object.keys(priceData[region][size]).sort();
            }
            
            if (frequencies.length === 0) {
                frequencies = [
                    "1 раз в две недели",
                    "1 раз в неделю", 
                    "2 раза в неделю",
                    "3 раза в неделю",
                    "4 раза в неделю",
                    "5 раз в неделю",
                    "6 раз в неделю",
                    "7 раз в неделю"
                ];
            }
            
            frequencySelect.innerHTML = '<option value="">Выберите периодичность замены</option>';
            
            frequencies.forEach(frequency => {
                const option = document.createElement('option');
                option.value = frequency;
                option.textContent = frequency;
                frequencySelect.appendChild(option);
            });
            
            frequencySelect.disabled = false;
        }
        
        // ============================================
        // АВТОМАТИЧЕСКОЕ ДОБАВЛЕНИЕ ПОЗИЦИЙ
        // ============================================
        function setupAutoPositionAddition() {
            const regionSelect = document.getElementById('region');
            const sizeSelect = document.getElementById('size');
            const frequencySelect = document.getElementById('frequency');
            const quantityInput = document.getElementById('quantity');
            
            if (!regionSelect || !sizeSelect || !frequencySelect || !quantityInput) return;
            
            const checkAndAddPosition = () => {
                if (!shouldAutoAdd) return;
                
                const region = regionSelect.value;
                const size = sizeSelect.value;
                const frequency = frequencySelect.value;
                const quantity = parseInt(quantityInput.value) || 1;
                
                if (region && size && frequency && quantity > 0) {
                    const pricePerReplacement = getPriceForPosition(region, size, frequency);
                    if (pricePerReplacement === 0) return;
                    
                    const existingPositionIndex = positions.findIndex(pos => 
                        pos.region === region && 
                        pos.size === size && 
                        pos.frequency === frequency
                    );
                    
                    if (existingPositionIndex >= 0) {
                        positions[existingPositionIndex].quantity = quantity;
                        positions[existingPositionIndex].pricePerReplacement = pricePerReplacement;
                        positions[existingPositionIndex].costPer4Weeks = calculateCostPer4Weeks(pricePerReplacement, quantity, frequency);
                        
                        showToast('Позиция обновлена', 'success');
                    } else {
                        const costPer4Weeks = calculateCostPer4Weeks(pricePerReplacement, quantity, frequency);
                        
                        const position = {
                            id: Date.now() + Math.random(),
                            region,
                            size,
                            frequency,
                            quantity,
                            pricePerReplacement,
                            costPer4Weeks
                        };
                        
                        positions.push(position);
                        showToast('Позиция добавлена в расчет', 'success');
                    }
                    
                    updatePositionsList();
                    updateTotalResult();
                }
            };
            
            regionSelect.addEventListener('change', checkAndAddPosition);
            sizeSelect.addEventListener('change', checkAndAddPosition);
            frequencySelect.addEventListener('change', checkAndAddPosition);
            quantityInput.addEventListener('input', checkAndAddPosition);
        }
        
        // ============================================
        // ОБНОВЛЕНИЕ СПИСКА ПОЗИЦИЙ
        // ============================================
        function updatePositionsList() {
            const positionsContainer = document.getElementById('positionsContainer');
            const positionsList = document.getElementById('positionsList');
            
            if (!positionsContainer || !positionsList) return;
            
            if (positions.length === 0) {
                positionsContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <i class="fas fa-info-circle" style="font-size: 24px; margin-bottom: 10px; display: block; color: #3498db;"></i>
                        <p>Позиции не добавлены</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Заполните форму выше, и позиция добавится автоматически</p>
                    </div>
                `;
                positionsList.style.display = 'none';
                return;
            }
            
            let html = '';
            
            positions.forEach((position, index) => {
                // Всегда показываем цену без НДС
                html += `
                    <div class="position-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <div style="background: #3498db; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-right: 10px;">
                                        ${index + 1}
                                    </div>
                                    <div style="font-weight: bold; color: #2c3e50; font-size: 1.1rem;">
                                        ${position.size.replace('*', '×')} × ${position.quantity} шт.
                                    </div>
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px; padding-left: 34px;">
                                    <i class="fas fa-sync-alt" style="color: #16a085; margin-right: 5px;"></i>
                                    ${position.frequency}
                                </div>
                                <div style="font-size: 0.9rem; color: #27ae60; padding-left: 34px;">
                                    <strong>Цена за замену:</strong> ${formatPrice(position.pricePerReplacement)}
                                </div>
                                <div style="font-size: 0.9rem; color: #c0392b; margin-top: 5px; padding-left: 34px;">
                                    <strong>Стоимость за 4 недели:</strong> ${formatPrice(position.costPer4Weeks)}
                                </div>
                                <div style="font-size: 0.85rem; color: #7f8c8d; margin-top: 5px; padding-left: 34px;">
                                    <i class="fas fa-map-marker-alt" style="color: #e74c3c;"></i> ${position.region}
                                </div>
                            </div>
                            <button class="remove-position-btn" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            positionsContainer.innerHTML = html;
            positionsList.style.display = 'block';
        }
        
        function removePosition(index) {
            if (index >= 0 && index < positions.length) {
                positions.splice(index, 1);
                updatePositionsList();
                updateTotalResult();
                showToast('Позиция удалена', 'info');
            }
        }
        
        // ============================================
        // ОБНОВЛЕНИЕ ИТОГОВОГО РЕЗУЛЬТАТА
        // ============================================
        function updateTotalResult() {
            const totalResult = document.getElementById('totalResult');
            if (!totalResult) return;
            
            if (positions.length === 0) {
                totalResult.style.display = 'none';
                return;
            }
            
            let totalCostWithoutVAT = 0;
            let allSameRegion = true;
            const firstRegion = positions[0].region;
            
            positions.forEach(position => {
                totalCostWithoutVAT += position.costPer4Weeks;
                if (position.region !== firstRegion) {
                    allSameRegion = false;
                }
            });
            
            let regionDisplay = allSameRegion ? firstRegion : 'Разные регионы';
            
            // Рассчитываем НДС только если включен
            const vatAmount = includeVAT ? totalCostWithoutVAT * VAT_RATE : 0;
            const totalWithVAT = includeVAT ? totalCostWithoutVAT + vatAmount : totalCostWithoutVAT;
            
            totalResult.innerHTML = `
                <div style="background: #16a085; color: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <i class="fas fa-receipt" style="font-size: 24px; margin-right: 10px;"></i>
                        <h4 style="margin: 0; color: white;">ИТОГОВЫЙ РАСЧЕТ</h4>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div><strong>Регион:</strong></div>
                        <div>${regionDisplay}</div>
                        
                        <div><strong>Количество позиций:</strong></div>
                        <div>${positions.length}</div>
                        
                        <div><strong>Общая стоимость за 4 недели:</strong></div>
                        <div style="font-size: 1.5rem; font-weight: 700;">
                            ${formatPrice(totalCostWithoutVAT)}
                        </div>
                    </div>
                    
                    <!-- Переключатель НДС -->
                    <div class="switch-container">
                        <div class="switch-label">
                            <h4>Мы можем работать с НДС 22%</h4>
                            <p>Хотите сделать расчет с НДС?</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="vatToggle" ${includeVAT ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <!-- Детализация НДС (только если включен) -->
                    <div class="vat-details ${includeVAT ? 'show' : ''}" id="vatDetails">
                        <div class="vat-row">
                            <span>Стоимость без НДС:</span>
                            <span>${formatPrice(totalCostWithoutVAT)}</span>
                        </div>
                        <div class="vat-row">
                            <span>НДС 22%:</span>
                            <span>${formatPrice(vatAmount)}</span>
                        </div>
                        <div class="vat-row">
                            <span>Итого с НДС:</span>
                            <span>${formatPrice(totalWithVAT)}</span>
                        </div>
                    </div>
                    
                    <p style="margin: 10px 0 0 0; font-size: 0.9rem; opacity: 0.9;">
                        <i class="fas fa-check-circle"></i> В стоимость входит: аренда ковра, чистка/сушка, доставка
                    </p>
                </div>
                
                <div style="margin-top: 20px;">
                    <button id="addPositionBtn" class="btn btn-secondary" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px;">
                        <i class="fas fa-plus-circle"></i> Добавить новую позицию
                    </button>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <button class="btn btn-telegram" id="sendToTelegram" style="padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <i class="fab fa-telegram"></i> Отправить в Telegram
                        </button>
                        <button class="btn btn-primary" id="sendToEmail" style="padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <i class="fas fa-envelope"></i> Отправить на Email
                        </button>
                    </div>
                </div>
            `;
            
            totalResult.style.display = 'block';
            
            // Обработчики для новых элементов
            const vatToggle = document.getElementById('vatToggle');
            if (vatToggle) {
                vatToggle.addEventListener('change', function() {
                    includeVAT = this.checked;
                    updateTotalResult();
                });
            }
            
            const sendToTelegramBtn = document.getElementById('sendToTelegram');
            if (sendToTelegramBtn) {
                sendToTelegramBtn.addEventListener('click', sendToTelegram);
            }
            
            const sendToEmailBtn = document.getElementById('sendToEmail');
            if (sendToEmailBtn) {
                sendToEmailBtn.addEventListener('click', sendToEmail);
            }
            
            const addPositionBtn = document.getElementById('addPositionBtn');
            if (addPositionBtn) {
                addPositionBtn.addEventListener('click', function() {
                    document.getElementById('region').value = '';
                    document.getElementById('size').innerHTML = '<option value="">Сначала выберите регион</option>';
                    document.getElementById('size').disabled = true;
                    document.getElementById('frequency').innerHTML = '<option value="">Сначала выберите размер</option>';
                    document.getElementById('frequency').disabled = true;
                    document.getElementById('quantity').value = '1';
                    
                    shouldAutoAdd = true;
                    showToast('Заполните поля выше для добавления новой позиции', 'info');
                    
                    document.querySelector('.calculator-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            }
        }
        
        // ============================================
        // ОТПРАВКА В TELEGRAM (ИСПРАВЛЕННАЯ ЛОГИКА НДС)
        // ============================================
        function sendToTelegram() {
            if (positions.length === 0) {
                alert('Сначала добавьте хотя бы одну позицию');
                return;
            }
            
            let totalCostWithoutVAT = 0;
            positions.forEach(position => {
                totalCostWithoutVAT += position.costPer4Weeks;
            });
            
            let message = `РАСЧЕТ АРЕНДЫ КОВРОВ\n\n`;
            
            positions.forEach((position, index) => {
                message += `${index + 1}. Размер ${position.size.replace('*', '×')} × ${position.quantity} шт.\n`;
                message += `   📍 ${position.region}\n`;
                message += `   Замены ${position.frequency}\n`;
                message += `   Цена за 1 чистый ковер: ${formatPrice(position.pricePerReplacement)}\n`;
                message += `   📊 Стоимость за 4 недели: ${formatPrice(position.costPer4Weeks)}\n\n`;
            });
            
            // ВСЕГДА показываем стоимость без НДС
            message += `Общая стоимость за 4 недели: ${formatPrice(totalCostWithoutVAT)}\n\n`;
            
            // НДС показываем ТОЛЬКО если включен
            if (includeVAT) {
                const vatAmount = totalCostWithoutVAT * VAT_RATE;
                const totalWithVAT = totalCostWithoutVAT + vatAmount;
                
                message += `Расчет с НДС 22%:\n`;
                message += `Без НДС: ${formatPrice(totalCostWithoutVAT)}\n`;
                message += `НДС 22%: ${formatPrice(vatAmount)}\n`;
                message += `Итого с НДС: ${formatPrice(totalWithVAT)}\n\n`;
            }
            
            message += `ДЛЯ ЗАКЛЮЧЕНИЯ ДОГОВОРА ПРИШЛИТЕ:\n`;
            message += `• Реквизиты компании\n`;
            message += `• Подписант (ФИО, основание полномочий)\n`;
            message += `• Точный адрес объекта и название, вывеска\n`;
            message += `• Режим работы объекта\n`;
            message += `• Контактное лицо (ФИО, телефон) для связи с курьером\n\n`;
            
            message += `Telegram: @+79770005127\n`;
            message += `Email: matservice@yandex.ru\n`;
            
            // Копирование текста
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = message;
            tempTextArea.style.position = 'fixed';
            tempTextArea.style.left = '-9999px';
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const telegramUrl = `https://t.me/+79770005127`;
                    window.open(telegramUrl, '_blank');
                    
                    setTimeout(() => {
                        alert('✅ Текст расчета скопирован!\n\n1. В Telegram вставьте текст (Ctrl+V)\n2. Отправьте сообщение\n3. Мы свяжемся в течение 15 минут!');
                    }, 1000);
                } else {
                    const encodedMessage = encodeURIComponent(message);
                    const fallbackUrl = `https://t.me/+79770005127?text=${encodedMessage}`;
                    window.open(fallbackUrl, '_blank');
                }
            } catch (err) {
                console.error('Ошибка:', err);
                const encodedMessage = encodeURIComponent(message);
                const fallbackUrl = `https://t.me/+79770005127?text=${encodedMessage}`;
                window.open(fallbackUrl, '_blank');
            } finally {
                document.body.removeChild(tempTextArea);
            }
        }
        
        // ============================================
        // ОТПРАВКА НА EMAIL (ИСПРАВЛЕННАЯ ЛОГИКА НДС)
        // ============================================
        function sendToEmail() {
            if (positions.length === 0) {
                alert('Сначала добавьте хотя бы одну позицию');
                return;
            }
            
            let totalCostWithoutVAT = 0;
            positions.forEach(position => {
                totalCostWithoutVAT += position.costPer4Weeks;
            });
            
            let subject = 'Расчет аренды ковров МИРУМ';
            subject += ` - ${new Date().toLocaleDateString('ru-RU')}`;
            
            let body = 'РАСЧЕТ АРЕНДЫ КОВРОВ\n\n';
            
            positions.forEach((position, index) => {
                body += `${index + 1}. Размер ${position.size.replace('*', '×')} × ${position.quantity} шт.\n`;
                body += `   📍 ${position.region}\n`;
                body += `   Замены ${position.frequency}\n`;
                body += `   Цена за 1 чистый ковер: ${position.pricePerReplacement.toLocaleString('ru-RU')} руб.\n`;
                body += `   📊 Стоимость за 4 недели: ${position.costPer4Weeks.toLocaleString('ru-RU')} руб.\n\n`;
            });
            
            // ВСЕГДА показываем стоимость без НДС
            body += `Общая стоимость за 4 недели: ${totalCostWithoutVAT.toLocaleString('ru-RU')} руб.\n\n`;
            
            // НДС показываем ТОЛЬКО если включен
            if (includeVAT) {
                const vatAmount = totalCostWithoutVAT * VAT_RATE;
                const totalWithVAT = totalCostWithoutVAT + vatAmount;
                
                body += `Расчет с НДС 22%:\n`;
                body += `Без НДС: ${totalCostWithoutVAT.toLocaleString('ru-RU')} руб.\n`;
                body += `НДС 22%: ${vatAmount.toLocaleString('ru-RU')} руб.\n`;
                body += `Итого с НДС: ${totalWithVAT.toLocaleString('ru-RU')} руб.\n\n`;
            }
            
            body += `ДЛЯ ЗАКЛЮЧЕНИЯ ДОГОВОРА ПРИШЛИТЕ:\n`;
            body += `• Реквизиты компании\n`;
            body += `• Подписант (ФИО, основание полномочий)\n`;
            body += `• Точный адрес объекта и название, вывеска\n`;
            body += `• Режим работы объекта\n`;
            body += `• Контактное лицо (ФИО, телефон) для связи с курьером\n\n`;
            
            body += `Telegram: @+79770005127\n`;
            body += `Email: matservice@yandex.ru\n`;
            body += `Сайт: https://arenda-kovrov-mirum.ru\n\n`;
            
            body += `Мы свяжемся с вами в течение 15 минут!`;
            
            const encodedSubject = encodeURIComponent(subject);
            const encodedBody = encodeURIComponent(body);
            const emailUrl = `mailto:matservice@yandex.ru?subject=${encodedSubject}&body=${encodedBody}`;
            
            window.open(emailUrl, '_blank');
        }
        
        // ============================================
        // ТЕНДЕРНЫЙ РАСЧЕТ
        // ============================================
        function initMonths() {
            const months = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            const container = document.getElementById('monthInputs');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            months.forEach(month => {
                const div = document.createElement('div');
                div.className = 'month-box';
                div.innerHTML = `
                    <label>${month}</label>
                    <input type="number" min="0" placeholder="Кол-во" id="${month}-qty">
                    <input type="number" min="0" placeholder="Замены" id="${month}-changes">
                `;
                container.appendChild(div);
            });
        }
        
        function calculateTender() {
            const region = document.getElementById('tender-region') ? document.getElementById('tender-region').value : '';
            const size = document.getElementById('tender-size') ? document.getElementById('tender-size').value : '';
            
            if (!region || !size) {
                alert('Пожалуйста, выберите регион и размер');
                return;
            }
            
            const pricePerReplacement = getPriceForPosition(region, size, "1 раз в неделю");
            
            if (pricePerReplacement === 0) {
                alert('Не удалось определить цену для выбранных параметров');
                return;
            }
            
            const months = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            let totalCost = 0;
            let tenderPositions = [];
            
            months.forEach(month => {
                const qtyInput = document.getElementById(`${month}-qty`);
                const changesInput = document.getElementById(`${month}-changes`);
                
                const qty = qtyInput ? parseInt(qtyInput.value) || 0 : 0;
                const changes = changesInput ? parseInt(changesInput.value) || 0 : 0;
                
                if (qty > 0 && changes > 0) {
                    const cost = pricePerReplacement * qty * changes;
                    totalCost += cost;
                    
                    tenderPositions.push({
                        month,
                        size,
                        quantity: qty,
                        changes,
                        cost
                    });
                }
            });
            
            if (tenderPositions.length === 0) {
                alert('Пожалуйста, укажите данные хотя бы для одного месяца');
                return;
            }
            
            displayTenderResults(tenderPositions, totalCost, region, size, pricePerReplacement);
        }
        
        function displayTenderResults(tenderPositions, totalCost, region, size, pricePerReplacement) {
            const tenderResultDiv = document.getElementById('tender-result');
            const tenderPositionsContainer = document.getElementById('tenderPositions');
            const tenderTotalValue = document.getElementById('tenderTotalValue');
            const tenderWithoutVat = document.getElementById('tenderWithoutVat');
            const tenderVatAmount = document.getElementById('tenderVatAmount');
            const tenderWithVat = document.getElementById('tenderWithVat');
            const tenderVatDetails = document.getElementById('tenderVatDetails');
            
            if (!tenderResultDiv || !tenderPositionsContainer) return;
            
            // Обновляем значения НДС
            const vatAmount = totalCost * VAT_RATE;
            const totalWithVAT = totalCost + vatAmount;
            
            if (tenderWithoutVat) tenderWithoutVat.textContent = formatPrice(totalCost);
            if (tenderVatAmount) tenderVatAmount.textContent = formatPrice(vatAmount);
            if (tenderWithVat) tenderWithVat.textContent = formatPrice(totalWithVAT);
            
            let html = `
                <div class="result-item">
                    <div class="result-label">Регион</div>
                    <div class="result-value">${region}</div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">Размер ковра</div>
                    <div class="result-value">${size.replace('*', '×')}</div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">Цена за замену</div>
                    <div class="result-value">${formatPrice(pricePerReplacement)}</div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4 style="color: white; margin-bottom: 10px;">Детализация по месяцам:</h4>
            `;
            
            tenderPositions.forEach(position => {
                html += `
                    <div class="result-item" style="margin-bottom: 8px;">
                        <div class="result-label">${position.month}</div>
                        <div class="result-value">${position.quantity} ковров × ${position.changes} замен = ${formatPrice(position.cost)}</div>
                    </div>
                `;
            });
            
            tenderPositionsContainer.innerHTML = html;
            
            // Показываем стоимость без НДС
            if (tenderTotalValue) {
                tenderTotalValue.textContent = formatPrice(totalCost);
            }
            
            tenderResultDiv.style.display = 'block';
            
            // Инициализация тумблера НДС для тендера
            const tenderVatToggle = document.getElementById('tenderVatToggle');
            if (tenderVatToggle) {
                tenderVatToggle.checked = false;
                tenderVatToggle.addEventListener('change', function() {
                    if (this.checked) {
                        tenderVatDetails.classList.add('show');
                        if (tenderTotalValue) {
                            tenderTotalValue.textContent = formatPrice(totalWithVAT);
                        }
                    } else {
                        tenderVatDetails.classList.remove('show');
                        if (tenderTotalValue) {
                            tenderTotalValue.textContent = formatPrice(totalCost);
                        }
                    }
                });
            }
            
            // Скрываем детализацию НДС по умолчанию
            if (tenderVatDetails) {
                tenderVatDetails.classList.remove('show');
            }
            
            window.tenderCalculation = {
                positions: tenderPositions,
                totalCost,
                vatAmount,
                totalWithVAT,
                region,
                size,
                pricePerReplacement,
                includeVAT: false
            };
            
            tenderResultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function sendTenderToTelegram() {
            if (!window.tenderCalculation) {
                alert('Сначала выполните расчет тендера');
                return;
            }
            
            try {
                const calc = window.tenderCalculation;
                const tenderVatToggle = document.getElementById('tenderVatToggle');
                const includeVATInTender = tenderVatToggle ? tenderVatToggle.checked : false;
                
                let message = `📋 ТЕНДЕРНЫЙ РАСЧЕТ АРЕНДЫ КОВРОВ МИРУМ\n\n`;
                
                message += `📍 Регион: ${calc.region}\n`;
                message += `📏 Размер ковра: ${calc.size.replace('*', '×')}\n`;
                message += `💰 Цена за замену: ${formatPrice(calc.pricePerReplacement)}\n`;
                
                // Всегда показываем стоимость без НДС
                message += `💰 Общая стоимость: ${formatPrice(calc.totalCost)}\n\n`;
                
                message += `📅 Детализация по месяцам:\n`;
                calc.positions.forEach(position => {
                    message += `• ${position.month}: ${position.quantity} ковров × ${position.changes} замен = ${formatPrice(position.cost)}\n`;
                });
                
                // НДС показываем ТОЛЬКО если включен
                if (includeVATInTender) {
                    message += `\nРасчет с НДС 22%:\n`;
                    message += `Без НДС: ${formatPrice(calc.totalCost)}\n`;
                    message += `НДС 22%: ${formatPrice(calc.vatAmount)}\n`;
                    message += `Итого с НДС: ${formatPrice(calc.totalWithVAT)}\n\n`;
                } else {
                    message += `\n`;
                }
                
                message += `📄 Для заключения договора потребуются:\n`;
                message += `• Реквизиты компании\n`;
                message += `• Подписант (ФИО, основание полномочий)\n`;
                message += `• Точный адрес объекта и название, вывеска\n`;
                message += `• Режим работы объекта\n`;
                message += `• Контактное лицо (ФИО, телефон) для связи с курьером\n\n`;
                
                message += `📝 УСЛОВИЯ:\n`;
                message += `Счёт выставляется только за фактические замены.\n`;
                message += `Возможно включить НДС 22% — цена увеличится на ставку налога.\n\n`;
                
                message += `📞 СВЯЗЬ:\n`;
                message += `Telegram: t.me/+79770005127\n`;
                message += `Email: matservice@yandex.ru\n`;
                message += `Сайт: arenda-kovrov-mirum.ru`;
                
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = message;
                tempTextArea.style.position = 'fixed';
                tempTextArea.style.left = '-9999px';
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        const telegramUrl = `https://t.me/+79770005127`;
                        window.open(telegramUrl, '_blank');
                        
                        setTimeout(() => {
                            alert('✅ Текст тендерного расчета скопирован!\n\n1. В Telegram вставьте текст\n2. Отправьте сообщение\n3. Мы свяжемся с вами!');
                        }, 1000);
                    } else {
                        const encodedMessage = encodeURIComponent(message);
                        const fallbackUrl = `https://t.me/+79770005127?text=${encodedMessage}`;
                        window.open(fallbackUrl, '_blank');
                    }
                } catch (err) {
                    console.error('Ошибка:', err);
                    const encodedMessage = encodeURIComponent(message);
                    const fallbackUrl = `https://t.me/+79770005127?text=${encodedMessage}`;
                    window.open(fallbackUrl, '_blank');
                } finally {
                    document.body.removeChild(tempTextArea);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Произошла ошибка. Пожалуйста, свяжитесь с нами напрямую через Telegram: @+79770005127');
            }
        }
        
        // ============================================
        // PWA ФУНКЦИОНАЛ
        // ============================================
        function setupPWA() {
            // Отслеживание онлайн/офлайн статуса
            function updateOnlineStatus() {
                const statusElement = document.getElementById('connectionStatus');
                if (statusElement) {
                    statusElement.textContent = navigator.onLine ? 'Онлайн' : 'Офлайн';
                    statusElement.style.color = navigator.onLine ? '#27ae60' : '#e74c3c';
                }
                
                if (!navigator.onLine) {
                    showToast('Работаете в автономном режиме. Расчеты доступны.', 'warning');
                }
            }
            
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
            
            // Установка PWA
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                const installContainer = document.getElementById('installContainer');
                const installButton = document.getElementById('installButton');
                
                if (installContainer && installButton) {
                    installContainer.style.display = 'block';
                    
                    installButton.addEventListener('click', () => {
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            deferredPrompt.userChoice.then((choiceResult) => {
                                if (choiceResult.outcome === 'accepted') {
                                    console.log('✅ Пользователь установил PWA');
                                    showToast('Приложение установлено!', 'success');
                                    installContainer.style.display = 'none';
                                }
                                deferredPrompt = null;
                            });
                        }
                    });
                    
                    // Автоматически скрываем через 10 секунд
                    setTimeout(() => {
                        if (installContainer.style.display !== 'none') {
                            installContainer.style.opacity = '0';
                            installContainer.style.transition = 'opacity 0.5s';
                            setTimeout(() => {
                                installContainer.style.display = 'none';
                                installContainer.style.opacity = '1';
                            }, 500);
                        }
                    }, 10000);
                }
            });
            
            // Проверяем, запущено ли приложение в standalone режиме
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                console.log('📱 Приложение запущено в standalone режиме');
                document.querySelector('.offline-badge').textContent = 'Установлено';
            }
        }
        
        // ============================================
        // ИНИЦИАЛИЗАЦИЯ ВСЕГО ПРИЛОЖЕНИЯ
        // ============================================
        function initApp() {
            console.log('🚀 PWA Приложение МИРУМ инициализируется');
            
            // 1. Инициализация интерфейса
            initInterface();
            
            // 2. Заполнение регионов
            populateRegions();
            
            // 3. Настройка обработчиков событий
            const regionSelect = document.getElementById('region');
            const sizeSelect = document.getElementById('size');
            const calculateTenderBtn = document.getElementById('calculateTenderBtn');
            const sendTenderToTelegramBtn = document.getElementById('sendTenderToTelegram');
            
            if (regionSelect) {
                regionSelect.addEventListener('change', function() {
                    handleRegionChange(this.value);
                });
            }
            
            if (sizeSelect) {
                sizeSelect.addEventListener('change', function() {
                    handleSizeChange(regionSelect ? regionSelect.value : '', this.value);
                });
            }
            
            if (calculateTenderBtn) {
                calculateTenderBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    calculateTender();
                });
            }
            
            if (sendTenderToTelegramBtn) {
                sendTenderToTelegramBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    sendTenderToTelegram();
                });
            }
            
            // Обработчик для кнопок удаления
            document.addEventListener('click', function(e) {
                if (e.target.closest('.remove-position-btn')) {
                    const index = e.target.closest('.remove-position-btn').dataset.index;
                    removePosition(parseInt(index));
                }
            });
            
            // 4. Настройка автоматического добавления позиций
            setupAutoPositionAddition();
            
            // 5. Инициализация месяцев для тендера
            initMonths();
            
            // 6. Настройка PWA функционала
            setupPWA();
            
            console.log('✅ PWA Приложение готово к работе');
            showToast('Приложение загружено и готово к работе!', 'success');
        }
        
        // ============================================
        // УПРАВЛЕНИЕ ТАБАМИ
        // ============================================
        window.showTab = function(tabName) {
            document.getElementById('standard-calc').style.display = 'none';
            document.getElementById('tender-calc').style.display = 'none';
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (tabName === 'standard') {
                document.getElementById('standard-calc').style.display = 'block';
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
            } else {
                document.getElementById('tender-calc').style.display = 'block';
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
            }
        };
        
        // ============================================
        // ЗАПУСК ПРИ ЗАГРУЗКЕ
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM загружен, запускаем приложение...');
            initApp();
        });
        
        // Экспорт функций для глобального доступа
        window.Calculator = {
            init: initApp,
            removePosition: removePosition,
            calculateTender: calculateTender,
            sendToTelegram: sendToTelegram,
            sendTenderToTelegram: sendTenderToTelegram,
            sendToEmail: sendToEmail
        };
        
        window.removePosition = removePosition;
    </script>
</body>
</html>